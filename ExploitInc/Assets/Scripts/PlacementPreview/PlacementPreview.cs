using System.Collections;
using UnityEngine;
using Zenject;

namespace SBaier.ExploitInc
{
	public class PlacementPreview : MonoBehaviour
	{
		
		[SerializeField]
		private Movable _movable = null;
		[SerializeField]
		private Transform _base = null;
		[SerializeField]
		private PinToPosition _pinToPosition = null;
		[SerializeField]
		private MenuShower _menuShower = null;
		private PlacementPreviewObject _previewObject;

		private Vector3 _position = Vector3.zero;
		public Vector3 Position => _position;

		private bool _hiding = false;

		[Inject]
		private void Construct(
			PlacementPreviewObject previewObject)
		{
			_previewObject = previewObject;
		}


		protected virtual void OnDestroy()
		{
			_menuShower.OnHidden -= destroyOnHidden;
			_menuShower.OnHidden -= reshowOnHidden;
		}

		public void SetPosition(Vector3 newPosition)
		{
			_movable.MoveTo(newPosition);
			_pinToPosition.TargetPos = newPosition;
			_position = newPosition;
		}

		public void Show()
		{
			_menuShower.Show();
			_previewObject.Show();
		}

		public void HideAndShowAt(Vector3 newPosition)
		{
			if (_hiding)
				return;

			_hiding = true;
			_position = newPosition;
			_menuShower.OnHidden += reshowOnHidden;
			_previewObject.Hide();
			_menuShower.Hide();
		}

		public void Hide()
		{
			if (_hiding)
				return;

			_hiding = true;
			StartCoroutine(hideAndDistroy());
			_previewObject.Hide();
		}

		private IEnumerator hideAndDistroy()
		{
			yield return 0;
			_menuShower.Hide();
			_menuShower.OnHidden += destroyOnHidden;
		}

		private void destroyOnHidden()
		{
			_menuShower.OnHidden -= destroyOnHidden;
			Destroy(_base.gameObject);
		}

		private void reshowOnHidden()
		{
			_menuShower.OnHidden -= reshowOnHidden;
			StartCoroutine(doRepositionOnHidden());
		}

		private IEnumerator doRepositionOnHidden()
		{
			yield return 0;
			SetPosition(_position);
			yield return 0;
			_hiding = false;
			_menuShower.Show();
			_previewObject.Show();
		}
	}
}