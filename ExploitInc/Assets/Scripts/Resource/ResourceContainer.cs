using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace SBaier.ExploitInc
{
	public class ResourceContainer : MonoBehaviour
	{
		[SerializeField]
		private ResourceType _type = ResourceType.Unset;
		public ResourceType Type => _type;
		[SerializeField]
		private int _maxAmount = 0;
		public int MaxAmount => _maxAmount;
		[SerializeField]
		private Transform _exploitPoint = null;
		public Transform ExploitPoint => _exploitPoint;
		[SerializeField]
		private Transform _resourceObject = null;


		public int Amount { get; private set; }

		public bool IsEmpty => Amount == 0;
		public Action OnEmpty;
		public Action OnAmountChanged;

		public GameObject ReservingObject { get; private set; }

		public bool Reserved => ReservingObject != null;


		protected virtual void Start()
		{
			Amount = _maxAmount;
		}


		public TakeRessourceResult Take(int requestedAmount)
		{
			if (IsEmpty)
				throw new InvalidOperationException();
			int taken = Mathf.Clamp(Amount, 0, requestedAmount);
			Amount -= taken;
			OnAmountChanged?.Invoke();
			if (IsEmpty)
				onEmpty();
			return new TakeRessourceResult(requestedAmount, taken, Type);
		}

		public void Add(int amountToAdd)
		{
			if (amountToAdd <= 0)
				throw new ArgumentException();
			Amount += amountToAdd;
			OnAmountChanged?.Invoke();
		}

		public void Reserve(GameObject reservingObject)
		{
			if (ReservingObject != null)
				throw new InvalidOperationException();
			ReservingObject = reservingObject;
		}

		public void CancelReservation(GameObject reservingObject)
		{
			if (ReservingObject != reservingObject)
				throw new InvalidOperationException();
			ReservingObject = null;
		}

		private void onEmpty()
		{
			_resourceObject.gameObject.SetActive(false);
			OnEmpty?.Invoke();
		}


		public class TakeRessourceResult
		{
			public int RequestedAmount { get; }
			public int ReceivedAmount { get; }
			public ResourceType Type { get; }

			public TakeRessourceResult(int requestedAmount,
				int receivedAmount, ResourceType type)
			{
				RequestedAmount = requestedAmount;
				ReceivedAmount = receivedAmount;
				Type = type;
			}
		}
	}
}