using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Zenject;

namespace SBaier.ExploitInc
{
	public class PlanetInteractionMenu : MonoBehaviour
	{
		private List<PlanetInteractionMenuElement> _elements = new List<PlanetInteractionMenuElement>();

		[SerializeField]
		private Transform _elementHook = null;
		[SerializeField]
		private Transform _base = null;
		[SerializeField]
		private float _showTime = 0.33f;
		[SerializeField]
		private CanvasGroup _group = null;
		[SerializeField]
		private float _hideTime = 0.5f;

		private bool _shown = false;
		private Coroutine _activeShowRoutine = null;
		private Coroutine _activeHideRoutine = null;

		private Vector3 _worldPos;
		private Camera _cam;


		[Inject]
		private void Construct([Inject(Id = "InputCamera")]Camera cam)
		{
			_cam = cam;
		}


		protected virtual void Start()
		{
			_group.interactable = false;
			_group.alpha = 0;
			_group.blocksRaycasts = false;
			Hide();
		}

		protected virtual void OnEnable()
		{
			reorder();
		}

		protected virtual void Update()
		{
			_base.position = _cam.WorldToScreenPoint(_worldPos);
		}

		public void ShowAt(Vector3 worldPos)
		{
			if (_activeHideRoutine != null)
				return;

			_worldPos = worldPos;
			if (_shown || _activeShowRoutine != null)
				return;

			_group.interactable = true;
			_group.alpha = 1;
			_group.blocksRaycasts = true;
			_shown = true;
			_activeShowRoutine = StartCoroutine(show());
		}

		private IEnumerator show()
		{
			float deltaTime = _showTime / _elements.Count;
			foreach (PlanetInteractionMenuElement element in _elements)
			{
				element.Show();
				yield return new WaitForSeconds(deltaTime);
			}
			yield return new WaitForSeconds(0.25f);
			_activeShowRoutine = null;
		}

		public void Hide()
		{
			if (_activeHideRoutine != null || _activeShowRoutine != null || !_shown)
				return;

			_shown = false;
			_group.interactable = false;
			_activeHideRoutine = StartCoroutine(hide());
		}

		private IEnumerator hide()
		{
			foreach (PlanetInteractionMenuElement element in _elements)
				element.Hide();
			yield return new WaitForSeconds(_hideTime); 
			_group.alpha = 0;
			_group.blocksRaycasts = false;
			_activeHideRoutine = null;
		}

		public void AddElement(PlanetInteractionMenuElement element)
		{
			_elements.Add(element);
			element.Base.SetParent(_elementHook, false);
			if (_shown)
				element.Show();
			reorder();
		}

		public void RemoveElement(PlanetInteractionMenuElement element)
		{
			if (!_elements.Contains(element))
				return;
			element.Hide();
			element.Base.SetParent(null);
			_elements.Remove(element);
			reorder();
		}

		private void reorder()
		{
			int count = _elements.Count;
			if (count == 0)
				return;
			float deltaAngle = 360 / count;
			for(int i = 0; i < count; i++)
			{
				PlanetInteractionMenuElement element = _elements[i];
				element.RotateTo((deltaAngle / 360) * i);
			}
		}
	}
}