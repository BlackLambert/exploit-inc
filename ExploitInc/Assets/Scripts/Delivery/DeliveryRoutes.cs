using System;
using System.Collections.Generic;

namespace SBaier.ExploitInc
{
	public class DeliveryRoutes
	{
		private Dictionary<Guid, List<DeliveryRoute>> _originToRoute = new Dictionary<Guid, List<DeliveryRoute>>();
		private Dictionary<Guid, List<DeliveryRoute>> _destinationToRoute = new Dictionary<Guid, List<DeliveryRoute>>();
		private List<DeliveryRoute> _routes = new List<DeliveryRoute>();
		public List<DeliveryRoute> RoutesCopy => new List<DeliveryRoute>(_routes);

		public event Action<DeliveryRoute> OnRouteAdded;
		public event Action<DeliveryRoute> OnRouteRemoved;

		public void Add(DeliveryRoute route)
		{
			if (_routes.Contains(route))
				throw new ArgumentException();
			_routes.Add(route);
			addTo(_originToRoute, route.Origin, route);
			addTo(_destinationToRoute, route.Destination, route);
			OnRouteAdded?.Invoke(route);
		}

		public void Remove(DeliveryRoute route)
		{
			if (!_routes.Contains(route))
				throw new ArgumentException();
			_routes.Remove(route);
			removeFrom(_originToRoute, route.Origin, route);
			removeFrom(_destinationToRoute, route.Destination, route);
			OnRouteRemoved?.Invoke(route);
		}

		public List<DeliveryRoute> GetByOrigin(DeliveryContainer origin)
		{
			if (!_originToRoute.ContainsKey(origin.Id))
				return new List<DeliveryRoute>();
			return _originToRoute[origin.Id];
		}

		public List<DeliveryRoute> GetByDestination(DeliveryContainer destination)
		{
			if (!_destinationToRoute.ContainsKey(destination.Id))
				return new List<DeliveryRoute>();
			return _destinationToRoute[destination.Id];
		}

		private void addTo(Dictionary<Guid, List<DeliveryRoute>> dictionary, DeliveryContainer container, DeliveryRoute route)
		{
			List<DeliveryRoute> routes;
			if(!dictionary.TryGetValue(container.Id, out routes))
			{
				routes = new List<DeliveryRoute>();
				dictionary[container.Id] = routes;
			}
			if (routes.Contains(route))
				throw new ArgumentException();
			routes.Add(route);
		}

		private void removeFrom(Dictionary<Guid, List<DeliveryRoute>> dictionary, DeliveryContainer container, DeliveryRoute route)
		{
			if (!dictionary.ContainsKey(container.Id))
				throw new ArgumentException();
			List<DeliveryRoute> routes = dictionary[container.Id];
			if (!routes.Contains(route))
				throw new ArgumentException();
			routes.Remove(route);
			if (routes.Count == 0)
				dictionary.Remove(container.Id);
		}
	}
}