
using System;
using UnityEngine;

namespace SBaier.ExploitInc
{
	public class MovablePlanetObject :  Movable
	{
		[SerializeField]
		private float _speed = 0.1f;
		[SerializeField]
		private float _rotationSpeed = 1f;
		[SerializeField]
		private Transform _base = null;
		[SerializeField]
		private Transform _center = null;

		private float _xRotation = 0;
		private float _yRotation = 0;

		public override event Action TargetReached;

		public Vector3 Target { get; private set; }
		private Vector3 CenterToTarget => Target - _center.position;
		private Vector3 ObjectToTarget => Target - _base.position;

		public override void MoveTo(Vector3 target)
		{
			Target = target;
			_xRotation = calculateXRotation();
			_yRotation = calculateYRotation();
		}

		public override void CancelMovement()
		{
			Target = Vector3.zero;
			_xRotation = 0;
			_yRotation = 0;
		}

		private float calculateXRotation()
		{
			return Vector3.Angle(_center.up, CenterToTarget);
		}

		private float calculateYRotation()
		{
			Vector3 projection = Vector3.ProjectOnPlane(ObjectToTarget, _center.up);
			return Vector3.Angle(_center.forward, projection);
		}


		protected virtual void FixedUpdate()
		{
			if (_yRotation != 0)
			{
				float factor = 1;
				factor = Vector3.Dot(_center.right, ObjectToTarget) > 0 ? 1 : -1;
				rotateArround(_center.up, _yRotation * factor, _rotationSpeed * factor);
				_yRotation = Mathf.Clamp(_yRotation - _rotationSpeed, 0, _yRotation);
			}
			else if (_xRotation != 0)
			{
				float delta = _speed;
				//delta = Vector3.Dot(_center.forward, ObjectToTarget) > 0 ? _speed : -_speed;
				rotateArround(_center.right, _xRotation, delta);
				_xRotation = Mathf.Clamp(_xRotation - _speed, 0, _xRotation);
				if (_xRotation == 0)
					TargetReached?.Invoke();
			}
		}

		private void rotateArround(Vector3 axis, float maxRotation, float deltaRotation)
		{
			float delta = deltaRotation;
			if (Mathf.Abs(maxRotation) <= Mathf.Abs(deltaRotation))
				delta = maxRotation;
			_center.RotateAround(_center.position, axis, delta);
		}
	}
}